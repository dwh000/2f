
说明:本工程专门应用于赛马公司触摸屏使用的产品.
2013年3月4
2F微机的程序采用新的书写方式,具体为:
	1.增加版本号,不同的程序有不同的版本号,版本号更替时,留下以前记录
	2.采用条件编译实现不同功能的版本,可以对除出程序外的程序更改时,所有程序都及时
	进行更改.方便多版本是针对某一功能的更改.
	3.通过编写代码,将版本号编译进入程序,方便区分程序版本.
	4.新的程序的函数括弧,向linux编码风格靠近.
	5.函数变量命名向C++靠近.变量定义时,应有明确注释,表明其作用.
	6.增加verctrl.h文件,用于版本控制.
	7.增加程序的调试模式,调试模式下,可以通过串口获得调试信息.
版本定义规则:
	采用6为数字定义形式为: X-aabb,其中X,aa,bb都为数字,可以用显示器显示.
	X表示大版本号,主要表明程序的功能,适合哪一类产品;
	aa表示该仅针对该功能产品代码的更新.针对该功能产品改进时,版本号加1
	bb表示公共部分代码的更新版本.公共部分代码更新时,该版本号加1
	每次小版本更细,必须在开发文档中留下明确的修改信息.包含,时间,作者,内容等.
	必要时应该标明更新原因.
	
	
本日开始编写针对赛马改造的程序,包含以下内容:
	1.按照2E气动的流程,完成主程序编写,实现称重及灌装测试功能.
	2.增加profibus-dp通信模块的程序,完成微机与dp工作站的数据通信.
	3.程序版本为00-000.
	
2013年3月6
关于定时器的分配,c8051f060共有5个定时器.其用途分配如下:
	定时器t0:用于产生5ms为基础定时的延时,可用于各种短时间延时函数.
	定时器t1:用于产生以100ms为基础的定时等待.用于菜单的延时退出.
	定时器t2:用于串口产生波特率.
	定时器t3:用于产生掉包脉冲.定时器为自动重装,初始化开启后不关闭
	定时器t4:用于闭环校正的延时.定时完成后,定时器关闭,等待下一次开启继续定时
	
2013年3月8
需要写的程序记录一下:
	1.在菜单栏增加通信地址设置,增加通信开关设置,增加程序版本查询.ok
	2.掉包计数的代码.ok
	
2013年3月13
关于profibus-dp的程序设计:
	1.完成GSD文件配置.
	2.完成总线初始化代码.在系统启动,DP参数设置过程中,应该调用初始化代码.系统调用
	初始化代码需要进行错误显示,参数设置不进行显示.
	3.完成数据交互代码.包含:
		a.发送数据的初始化.发送数据初始化是分散的,根据数据的变化在程序的不同地方
		更新
		b.根据标志更新主站设置的数据,更新完成后置向发送数据置已更新标志!
		c.根据标志复位数据已更新标志.
	4.数据初始化实时完成.数据发送采用定时中断发送.暂定1S进行一次数据交互,并且在
	重量>20KG时不进行数据交互.或者,采用函数调用形式进行数据交互.具体视数据交互时
	CPU的处理袋重是否有实时压力来更改
	5.2F程序与oem板的数据传送采用中断方式.
	
新设计电路图需要更新程序的地方.
	1.20c04写保护管脚更新
	2.P06,P07,P30更换为DP模块控制引脚
	3.相关管脚需要根据需要重新交叉配置.
	4.下版电路设置在REQ_IT脚增加下拉电阻,可以检测PB-OEM模块是否插接.
	
2013年3月28日
仍然需要完成的工作:
	1.修改传感器量程设置程序,满足更多的传感器量程
	2.完成DP设置参数的保存程序.
	3.增加通信程序强壮性代码,使通信能够自动复位,自动复位后应重新刷新交互数据

2013年4月9日
2f程序已经完成:
	1.通信程序已完成了自动复位及复位后的交互数据刷新.
	2.完成了传感器量程设置程序的修改,增加了250,300,350传感器的设置
	3.完成了DP参数保存程序.增加dp修改参数中滤波系数的修正.wincc主站已经完成.

2013年4月16日
 
2F微机新流程气动程序: 
	A. DP通信部分: 
		1.增加DP通信程序. 
		2.调整微机与dp模块通信的波特率并进行测试,尽量减少CPU用于数据交互的时间.
		适当提高微机刷新交互数据的频率. 
		3.修改 IO 配置表,增加输出变量用来控制微机包装程序及微机各输出IO的使能与
		禁止的变量,并编写相应代码完成相应的功能. 
		4.针对上位机控制去皮及标定的功能进行修改优化. 
		5.修改wincc demo程序,满足上述控制需要. 
	B. 编写首次上电微机参数初始化程序,完成大部分参数以默认值初始化并存储以方便首
	次上电调试. 完成
	C. 功能调试.

完成内容:
	1.波特率更改为1152000,刷新频率更改为10Hz.
	2.增加了AD错误的诊断代码,避免因AD错误而引起死机.
	3.调整参数读取时读取DP地址和DP开关的顺序,DP开关不开则不读取DP地址参数.
	
2013年4月17日
完成内容:
	1.完成了初次上电初始化程序,并调试通过.
	

2013年5月3日
需要完成的工作内容:
	1.增加插袋检测的处理程序,以解决灌装冲灰引起的插袋检测信号消失.未写入流程图且
	而需要增加的内容(于2013年5月7日完成)
	2.有插袋检测信号,清零点清不清零的问题.应该采用不掉包不清零,防止过清零点前插
	袋,无法清零(暂时不做修改,根据实际情况修改)	  	  
  	  
完成的内容:
	1.完成PB常规参数的初始化.
	2.新增输入点参数初始化.
		
		
2013年5月4日
完成了以下能容:
	1.试验了电脑超级终端采集数据存储到excel的方法.
	2.优化程序,使之更紧凑简洁,使程序更具模块化.
	3.修改了saima粗修流切换部分的程序,增加开关控制
	4.修改了saima的50公斤点的程序,满足50公斤点数据显示1s
	
2013年5月6日
完成的工作内容:
	1.为解决采样速度的问题,重新编写了AD转换的代码.完成了采样速度与系统稳定性的兼	
	顾 .目前称重数据的算法为:采集了34个数据,除去最大值,最小值,求平均值.-->一阶低
	通滤波-->工程量变换(传感器信号变成重量)-->去皮计算-->标度变换(根据标定计数实
	际重量).现在有效数据采样速度大约为 120次/秒.
	  
2013年5月7日
需要完成的内容:
	1.完整的通过PB标定的功能,包含以下操作:(2013年5月13日 完成)
		a.去皮操作.
		b.标定砝码输出值读取.
		c.标定砝码值的写入.
	2.增加通讯数据长度,涉及到修改GSD配置文件,长度按照以下需要酌情增加.(已完成)
		a.信号输入点		7bit (输入部分)
		b.满足通信标称的需要,增加:
			砝码输出值	4字节(输入部分)
			去皮操作标志	1bit (输出部分)
			去皮完成标志	1bit (输入部分)
		c.完成以下功能(已完成)
			禁止包装		1bit (输出部分)		//实际禁止为下一圈灌装开始时.
			强制关电机	1bit (输出部分)
			强制关闸板	1bit (输出部分)
			强制不掉袋	1bit (输出部分)
	3.修改通信初始化及数据交互程序,编写强行禁止功能的代码,编写通信标称代码.
	4.修改编写主站组态及wincc demo程序,完成上述控制功能.(2013年5月14日 完成)

完成的工作:
	1.8EXE程序中,增加了调试代码,实现了称重数据通过串口格式化输出,可以结合电脑将
	数据保存到excel表格,以方便观察及调试.
	2.修改插袋检测点的处理程序.屏蔽灌装冲灰引起的插袋检测信号消失.
	3.修改GSD文件,I/O配置为64字节输入,48字节输出.
	4.修改I/O配置的excel表格,完成变量分配.
	
2013年5月8日
完成的工作:
	1.完成通信初始化程序,完成信号出入点的数据交互,完成了强制禁止功能的代码.
	2.完成新GSD文件的组态,完成了PC站的配置.
	3.调试程序,完成了修改后的微机与PC站的通信.
	
2013年5月9日
完成的内容:
	1.8exe中,修改pb通信检测网络状态并复位初始化代码的位置.
	2.调试检查PB连接掉线的原因.
	
2013年5月10日
完成的内容:
	1.交互数据中增加输出点的刷新.
	
2013年5月11日
完成的内容:
	1.在WINCC demo及2F微机程序中增加代码完成了强制禁止等功能.
	
	
2013年5月13日
完成的内容:
	1.微机程序中,增加去皮标定的代码.增加参数报警的数据交互.
	2.wincc demo程序中增加去皮标定的操作.
	3.wincc demo修改参数界面增加参数报警.
	
	
2013年5月14日
完成的内容:
	1.wincc demo完成了全部控制功能.
	2.微机程序配合wincc控制,完成了相应的代码.
	
	
2013年5月24日
1.查看了ad代码,未发现问题
2.修改了显示刷新代码,200ms刷新一次,或者重量差超过200g刷新一次.

2013年5月29日
1修改了DP通信地址读取中的bUG

2013年11月22日
更新内容:
	1.配合BHYW/BHYW-DP	2013.9版本的PCB,更新AD采样程序,取消AD程序每次采样的复位操作,提高程序的运行速度.但该程序必须基于四层电路板的硬件之上!
	2.更新联网标定的部分代码,以更好的完成联网标定的功能!
	联网标定的操作步骤为:		a. 去皮.去皮操作只在灌装未达到设定值时响应!
							b. 未标定净重值的刷新,未标定净重值只在(<(设定值-5) 或者 >(设定值) )时,刷新;故标称时,放上砝码,如果砝码称重值<设定值 ,可以施加外力,使输出>设定值
							后,撤销外力,后读取未标定净重值!
							c.修改参数.
	3.更新输入输出测试程序中的小bug,如下:
		a.更新输入测试无输入时的显示为NO INPUT.
		B.修改输出测试的菜单显示为OUTPUT.
	4.更新接近设定值时,禁止DP通信的代码.(该部分代码,为了提高即将满称时的称量精度)
		将二次关闸板值控制DP通信禁止修改为(设定值-3.0KG)禁止DP通信.
	5.增加如果按下SET按键复位,则初始化系统参数!
		
		
2014年2月22日
更新内容:
    1.重新定义了掉包计数器,并根据复位源的类型,初始化掉包计数器.除非为上电复位,否则不清零掉包计数器.
    解决计数器重启掉包计数器清零的问题.
    2.在掉包计数器开关的菜单中增加清零掉包计数器的代码,用于本地清零掉包计数器.
    3.更改二次关闸板设定值的方式,参数设置的为调整量.二次关闸板值 = 关闸板判别值 - 二次关闸板调整值!
    4.更改二次关闸板参数修改的相关内容,参数修改的范围为100-10000.
    5.修改参数读取内容,参数读取后,计算二次关闸板值.
    6.修改联网设置参数的相关内容.
    7.增加袋重设定值修改后,二次关闸板值的计算程序,包含设定值直接修改,设定值设置菜单修改及设定值联网修改



2014年4月8日
更新内容:
    1.更新了PB通讯时,串口接收数据的函数,增加了S_RTS信号检测,防止串口接收数据超时,并增加了数据超时的相应处理.
    2.更新了PB通讯时数据刷新的方式,改分布式刷新为通信时集中刷新,方便以后通讯部分的程序维护.
    3.新增加了通讯的超时溢出.






















































            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            